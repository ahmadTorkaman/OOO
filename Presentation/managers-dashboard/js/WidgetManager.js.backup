// Widget Manager - Handles widget lifecycle and rendering
export class WidgetManager {
    constructor(dashboard) {
        this.dashboard = dashboard;
        this.widgets = [];
        this.charts = {};
    }

    addWidget(type, customConfig = null) {
        const widgetId = `widget-${Date.now()}`;
        const widget = {
            id: widgetId,
            type: type,
            data: this.getWidgetData(type),
            config: customConfig || this.getDefaultConfig(type)
        };

        this.widgets.push(widget);
        this.renderWidget(widget);
        return widget;
    }

    renderWidget(widget) {
        const dashboardGrid = document.getElementById('dashboard-grid');
        const widgetEl = document.createElement('div');
        widgetEl.className = 'widget-container fade-in';
        widgetEl.id = widget.id;
        widgetEl.dataset.type = widget.type;

        const widgetConfig = this.getWidgetConfig(widget.type);
        const hasCustomization = this.hasCustomization(widget.type);

        widgetEl.innerHTML = `
            <div class="widget-header">
                <div class="widget-title">
                    <span class="widget-icon">${widgetConfig.icon}</span>
                    ${widgetConfig.title}
                </div>
                <div class="widget-controls">
                    ${hasCustomization ? `<button class="widget-btn customize" title="Customize" onclick="dashboard.widgetManager.customizeWidget('${widget.id}')">⚙</button>` : ''}
                    <button class="widget-btn refresh" title="Refresh" onclick="dashboard.widgetManager.refreshWidget('${widget.id}')">↻</button>
                    <button class="widget-btn delete" title="Remove" onclick="dashboard.widgetManager.removeWidget('${widget.id}')">×</button>
                </div>
            </div>
            <div class="widget-body" id="${widget.id}-body">
                ${this.renderWidgetBody(widget)}
            </div>
        `;

        dashboardGrid.appendChild(widgetEl);

        // Initialize charts if needed - with proper delay
        if (widgetConfig.hasChart) {
            setTimeout(() => this.initializeChart(widget), 200);
        }
    }

    hasCustomization(type) {
        return ['team-capacity', 'delivery-trends', 'strategic-goals', 'task-manager'].includes(type);
    }

    customizeWidget(widgetId) {
        const widget = this.widgets.find(w => w.id === widgetId);
        if (!widget) return;

        this.dashboard.modalManager.showCustomizationModal(widget);
    }

    getWidgetConfig(type) {
        const configs = {
            'cash-flow': { title: 'Cash Flow & Runway', icon: '$', hasChart: true, drillDown: true },
            'revenue-target': { title: 'Revenue vs Target', icon: '⊙', hasChart: true, drillDown: true },
            'profit-product': { title: 'Profit by Product', icon: '▥', hasChart: true, drillDown: true },
            'accounts-receivable': { title: 'Accounts Receivable', icon: '⟳', hasChart: true, drillDown: true },
            'live-prices': { title: 'Live Market Prices', icon: '◈', hasChart: true, drillDown: false },
            'order-pipeline': { title: 'Order Pipeline', icon: '▦', hasChart: false, drillDown: true },
            'delivery-trends': { title: 'Delivery Time Trends', icon: '↗', hasChart: true, drillDown: true },
            'bottleneck-map': { title: 'Bottleneck Heatmap', icon: '⚠', hasChart: false, drillDown: true },
            'team-capacity': { title: 'Team Capacity', icon: '▧', hasChart: true, drillDown: true },
            'customer-health': { title: 'Customer Health Score', icon: '☺', hasChart: true, drillDown: true },
            'sales-pipeline': { title: 'Sales Pipeline', icon: '▽', hasChart: true, drillDown: true },
            'top-customers': { title: 'Top Customers', icon: '★', hasChart: false, drillDown: true },
            'team-scorecard': { title: 'Team Performance', icon: '◎', hasChart: false, drillDown: true },
            'overdue-tasks': { title: 'Overdue Tasks', icon: '!', hasChart: false, drillDown: true },
            'strategic-goals': { title: 'Strategic Goals Q4 2024', icon: '◉', hasChart: false, drillDown: true },
            'task-manager': { title: 'My Tasks', icon: '✓', hasChart: false, drillDown: true }
        };
        return configs[type] || { title: 'Widget', icon: '◆', hasChart: false, drillDown: false };
    }

    getDefaultConfig(type) {
        const defaults = {
            'team-capacity': { showPercentage: true, highlightOver100: true },
            'delivery-trends': { showTarget: true, timeframe: '12weeks' },
            'strategic-goals': { showProgress: true, sortBy: 'priority' },
            'task-manager': { view: 'list', filter: 'all', sortBy: 'dueDate' }
        };
        return defaults[type] || {};
    }

    renderWidgetBody(widget) {
        const renderers = {
            'cash-flow': this.renderCashFlowWidget,
            'revenue-target': this.renderRevenueTargetWidget,
            'profit-product': this.renderProfitProductWidget,
            'accounts-receivable': this.renderARWidget,
            'live-prices': this.renderLivePricesWidget,
            'order-pipeline': this.renderOrderPipelineWidget,
            'delivery-trends': this.renderDeliveryTrendsWidget,
            'team-capacity': this.renderTeamCapacityWidget,
            'customer-health': this.renderCustomerHealthWidget,
            'sales-pipeline': this.renderSalesPipelineWidget,
            'top-customers': this.renderTopCustomersWidget,
            'team-scorecard': this.renderTeamScorecardWidget,
            'overdue-tasks': this.renderOverdueTasksWidget,
            'strategic-goals': this.renderStrategicGoalsWidget,
            'bottleneck-map': this.renderBottleneckWidget,
            'task-manager': this.renderTaskManagerWidget
        };

        const renderer = renderers[widget.type];
        return renderer ? renderer.call(this, widget.data, widget.id) : '<p>Widget content</p>';
    }

    // Widget Renderers
    renderCashFlowWidget(data, widgetId) {
        return `
            <div class="kpi-card clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'cash-flow')">
                <div class="kpi-label">Current Cash Balance</div>
                <div class="kpi-value">$${data.balance.toLocaleString()}</div>
                <div class="kpi-trend ${data.trend >= 0 ? 'positive' : 'negative'}">
                    ${data.trend >= 0 ? '↗' : '↘'} ${Math.abs(data.trend)}% from last month
                </div>
                <div class="kpi-label" style="margin-top: 12px;">Runway: ${data.runway} days</div>
            </div>
            <canvas id="chart-${data.chartId}" class="chart-container"></canvas>
        `;
    }

    renderRevenueTargetWidget(data, widgetId) {
        return `
            <div class="kpi-card clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'revenue-target')">
                <div class="kpi-label">Monthly Revenue</div>
                <div class="kpi-value">$${data.actual.toLocaleString()}</div>
                <div class="kpi-label">Target: $${data.target.toLocaleString()} (${data.percentage}%)</div>
                <div class="kpi-trend ${data.onTrack ? 'positive' : 'negative'}">
                    ${data.onTrack ? 'On Track' : 'Behind'}
                </div>
            </div>
            <canvas id="chart-${data.chartId}" class="chart-container"></canvas>
        `;
    }

    renderProfitProductWidget(data, widgetId) {
        return `<canvas id="chart-${data.chartId}" class="chart-container" style="height: 220px;"></canvas>`;
    }

    renderARWidget(data, widgetId) {
        return `
            <div class="kpi-card clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'accounts-receivable')">
                <div class="kpi-label">Total AR</div>
                <div class="kpi-value">$${data.total.toLocaleString()}</div>
                <div class="kpi-label" style="color: #e74c3c;">Overdue: $${data.overdue.toLocaleString()}</div>
            </div>
            <canvas id="chart-${data.chartId}" class="chart-container"></canvas>
        `;
    }

    renderLivePricesWidget(data, widgetId) {
        return `
            <div class="price-cards">
                <div class="price-card">
                    <div class="price-label">Gold (oz)</div>
                    <div class="price-value">$${data.gold.price}</div>
                    <div class="price-change ${data.gold.change >= 0 ? 'up' : 'down'}">
                        ${data.gold.change >= 0 ? '↑' : '↓'} ${Math.abs(data.gold.change)}% (24h)
                    </div>
                    <canvas id="chart-gold-${widgetId}" class="price-chart"></canvas>
                </div>
                <div class="price-card">
                    <div class="price-label">USD to IRR</div>
                    <div class="price-value">${data.usd.price}</div>
                    <div class="price-change ${data.usd.change >= 0 ? 'up' : 'down'}">
                        ${data.usd.change >= 0 ? '↑' : '↓'} ${Math.abs(data.usd.change)}% (24h)
                    </div>
                    <canvas id="chart-usd-${widgetId}" class="price-chart"></canvas>
                </div>
            </div>
        `;
    }

    renderOrderPipelineWidget(data, widgetId) {
        return `
            <div class="pipeline-stages clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'order-pipeline')">
                ${data.stages.map(stage => `
                    <div class="pipeline-stage">
                        <span class="stage-indicator ${stage.color}"></span>
                        <span class="stage-label">${stage.label}</span>
                        <span class="stage-count">${stage.count}</span>
                        <span class="stage-percentage">(${stage.percentage}%)</span>
                    </div>
                `).join('')}
            </div>
        `;
    }

    renderDeliveryTrendsWidget(data, widgetId) {
        return `
            <div class="kpi-card clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'delivery-trends')">
                <div class="kpi-label">Average Delivery Time</div>
                <div class="kpi-value">${data.current} days</div>
                <div class="kpi-label">Target: ${data.target} days</div>
            </div>
            <canvas id="chart-${data.chartId}" class="chart-container"></canvas>
        `;
    }

    renderTeamCapacityWidget(data, widgetId) {
        return `<canvas id="chart-${data.chartId}" class="chart-container" style="height: 220px;"></canvas>`;
    }

    renderCustomerHealthWidget(data, widgetId) {
        return `<canvas id="chart-${data.chartId}" class="chart-container" style="height: 220px;"></canvas>`;
    }

    renderSalesPipelineWidget(data, widgetId) {
        return `<canvas id="chart-${data.chartId}" class="chart-container" style="height: 220px;"></canvas>`;
    }

    renderTopCustomersWidget(data, widgetId) {
        return `
            <table class="widget-table clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'top-customers')">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Revenue</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.customers.map(c => `
                        <tr>
                            <td>${c.name}</td>
                            <td>$${c.revenue.toLocaleString()}</td>
                            <td><span class="status-badge ${c.status}">${c.statusText}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    renderTeamScorecardWidget(data, widgetId) {
        return `
            <table class="widget-table clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'team-scorecard')">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Tasks</th>
                        <th>Rating</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.team.map(m => `
                        <tr>
                            <td>${m.name}</td>
                            <td>${m.tasks}</td>
                            <td>${m.rating}</td>
                            <td><span class="status-badge ${m.status}">${m.statusText}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    renderOverdueTasksWidget(data, widgetId) {
        return `
            <div class="pipeline-stages clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'overdue-tasks')">
                ${data.departments.map(dept => `
                    <div class="pipeline-stage">
                        <span class="stage-label">${dept.name}</span>
                        <span class="stage-count">${dept.count} tasks</span>
                        <span class="stage-percentage">(avg ${dept.avgDays}d late)</span>
                    </div>
                `).join('')}
            </div>
        `;
    }

    renderStrategicGoalsWidget(data, widgetId) {
        return data.goals.map(goal => `
            <div class="progress-bar-container clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'strategic-goals', ${goal.id || 0})">
                <div class="progress-label">
                    <span>${goal.name}</span>
                    <span>${goal.progress}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${goal.progress}%"></div>
                </div>
                <div class="kpi-label" style="font-size: 11px; margin-top: 4px;">${goal.status}</div>
            </div>
        `).join('');
    }

    renderBottleneckWidget(data, widgetId) {
        return `
            <div class="pipeline-stages clickable" onclick="dashboard.drillDownManager.show('${widgetId}', 'bottleneck-map')">
                ${data.processes.map(proc => `
                    <div class="pipeline-stage" style="border-left: 3px solid ${proc.severity === 'high' ? '#e74c3c' : proc.severity === 'medium' ? '#f39c12' : '#27ae60'}">
                        <span class="stage-label">${proc.name}</span>
                        <span class="stage-count">${proc.time} days</span>
                        <span class="stage-percentage">${proc.status}</span>
                    </div>
                `).join('')}
            </div>
        `;
    }

    renderTaskManagerWidget(data, widgetId) {
        const tasks = data.tasks || [];
        const filter = data.filter || 'all';

        return `
            <div class="task-manager-widget">
                <div class="task-filters">
                    <button class="filter-btn ${filter === 'all' ? 'active' : ''}" onclick="dashboard.widgetManager.filterTasks('${widgetId}', 'all')">All</button>
                    <button class="filter-btn ${filter === 'today' ? 'active' : ''}" onclick="dashboard.widgetManager.filterTasks('${widgetId}', 'today')">Today</button>
                    <button class="filter-btn ${filter === 'week' ? 'active' : ''}" onclick="dashboard.widgetManager.filterTasks('${widgetId}', 'week')">This Week</button>
                </div>
                <div class="task-list">
                    ${tasks.length === 0 ? '<p class="no-tasks">No tasks yet. Create one below!</p>' :
                        tasks.map(task => `
                            <div class="task-item ${task.completed ? 'completed' : ''}" onclick="dashboard.widgetManager.toggleTask('${widgetId}', ${task.id})">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} onclick="event.stopPropagation(); dashboard.widgetManager.toggleTask('${widgetId}', ${task.id})">
                                <div class="task-content">
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-meta">
                                        ${task.dueDate ? `<span class="task-due ${this.isOverdue(task.dueDate) ? 'overdue' : ''}">${this.formatDueDate(task.dueDate)}</span>` : ''}
                                        ${task.priority ? `<span class="task-priority priority-${task.priority}">${task.priority}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                </div>
                <button class="btn-primary btn-sm add-task-btn" onclick="dashboard.modalManager.showTaskModal('${widgetId}')">+ Add Task</button>
            </div>
        `;
    }

    isOverdue(dueDate) {
        return new Date(dueDate) < new Date();
    }

    formatDueDate(dueDate) {
        const date = new Date(dueDate);
        const today = new Date();
        const diff = Math.ceil((date - today) / (1000 * 60 * 60 * 24));

        if (diff === 0) return 'Today';
        if (diff === 1) return 'Tomorrow';
        if (diff === -1) return 'Yesterday';
        if (diff < 0) return `${Math.abs(diff)} days ago`;
        return `In ${diff} days`;
    }

    filterTasks(widgetId, filter) {
        const widget = this.widgets.find(w => w.id === widgetId);
        if (!widget) return;

        widget.data.filter = filter;
        this.refreshWidget(widgetId);
    }

    toggleTask(widgetId, taskId) {
        const widget = this.widgets.find(w => w.id === widgetId);
        if (!widget) return;

        const task = widget.data.tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            this.refreshWidget(widgetId);
        }
    }

    addTask(widgetId, taskData) {
        const widget = this.widgets.find(w => w.id === widgetId);
        if (!widget) return;

        const task = {
            id: Date.now(),
            ...taskData,
            completed: false,
            createdAt: new Date().toISOString()
        };

        widget.data.tasks.push(task);
        this.refreshWidget(widgetId);
    }

    // Continued in next part...
    removeWidget(widgetId) {
        const widgetEl = document.getElementById(widgetId);
        if (widgetEl) {
            widgetEl.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                widgetEl.remove();
                this.widgets = this.widgets.filter(w => w.id !== widgetId);

                // Clean up chart if exists
                const widget = this.widgets.find(w => w.id === widgetId);
                if (widget && widget.data.chartId && this.charts[widget.data.chartId]) {
                    this.charts[widget.data.chartId].destroy();
                    delete this.charts[widget.data.chartId];
                }
            }, 300);
        }
    }

    refreshWidget(widgetId) {
        const widget = this.widgets.find(w => w.id === widgetId);
        if (widget) {
            // Don't regenerate data for task-manager, keep existing tasks
            if (widget.type !== 'task-manager') {
                widget.data = this.getWidgetData(widget.type);
            }

            const bodyEl = document.getElementById(`${widgetId}-body`);
            if (bodyEl) {
                bodyEl.innerHTML = this.renderWidgetBody(widget);
                if (this.getWidgetConfig(widget.type).hasChart) {
                    setTimeout(() => this.initializeChart(widget), 200);
                }
            }
        }
    }

    getWidgetData(type) {
        const chartId = `${type}-${Date.now()}`;
        const dataGenerators = {
            'cash-flow': () => ({
                balance: 245000,
                trend: -12,
                runway: 45,
                chartId: chartId
            }),
            'revenue-target': () => ({
                actual: 1700000,
                target: 2000000,
                percentage: 85,
                onTrack: true,
                chartId: chartId
            }),
            'profit-product': () => ({
                chartId: chartId,
                products: ['Custom Furniture', 'Standard Tables', 'Chairs', 'Accessories'],
                margins: [42, 18, -3, 28]
            }),
            'accounts-receivable': () => ({
                total: 340000,
                overdue: 120000,
                chartId: chartId
            }),
            'live-prices': () => ({
                gold: { price: '2,045.30', change: 0.8 },
                usd: { price: '42,150', change: 0.2 }
            }),
            'order-pipeline': () => ({
                stages: [
                    { label: 'On Track', count: 45, percentage: 67, color: 'green' },
                    { label: 'At Risk', count: 15, percentage: 22, color: 'yellow' },
                    { label: 'Overdue', count: 8, percentage: 11, color: 'red' },
                    { label: 'Blocked', count: 3, percentage: 4, color: 'gray' }
                ]
            }),
            'delivery-trends': () => ({
                current: 12,
                target: 10,
                chartId: chartId
            }),
            'team-capacity': () => ({
                chartId: chartId,
                teams: ['Design', 'Production', 'QC', 'Logistics'],
                utilization: [85, 112, 45, 78]
            }),
            'customer-health': () => ({
                chartId: chartId,
                segments: ['Happy (NPS 9-10)', 'Neutral (NPS 7-8)', 'Unhappy (NPS 0-6)'],
                percentages: [72, 19, 9]
            }),
            'sales-pipeline': () => ({
                chartId: chartId,
                stages: ['Leads', 'Proposals', 'Negotiation', 'Closing'],
                values: [2300000, 890000, 340000, 180000]
            }),
            'top-customers': () => ({
                customers: [
                    { name: 'Client A', revenue: 450000, status: 'success', statusText: 'Active' },
                    { name: 'Client B', revenue: 320000, status: 'warning', statusText: 'At Risk' },
                    { name: 'Client C', revenue: 280000, status: 'success', statusText: 'Active' }
                ]
            }),
            'team-scorecard': () => ({
                team: [
                    { name: 'Sarah', tasks: 12, rating: '4.8', status: 'success', statusText: 'On Track' },
                    { name: 'Mike', tasks: 8, rating: '4.9', status: 'success', statusText: 'On Track' },
                    { name: 'John', tasks: 3, rating: '3.2', status: 'warning', statusText: 'Needs Support' },
                    { name: 'Alex', tasks: 5, rating: '4.1', status: 'danger', statusText: 'Overdue' }
                ]
            }),
            'overdue-tasks': () => ({
                departments: [
                    { name: 'Engineering', count: 8, avgDays: 5 },
                    { name: 'Admin', count: 14, avgDays: 12 },
                    { name: 'Design', count: 3, avgDays: 2 },
                    { name: 'Production', count: 2, avgDays: 1 }
                ]
            }),
            'strategic-goals': () => ({
                goals: [
                    { id: 1, name: 'Increase Revenue to $2M', progress: 85, status: '30 days left' },
                    { id: 2, name: 'Reduce Delivery Time to 10 Days', progress: 80, status: 'Behind' },
                    { id: 3, name: 'Hire 5 New Team Members', progress: 60, status: 'On track' },
                    { id: 4, name: 'Launch New Product Line', progress: 70, status: 'At risk' },
                    { id: 5, name: 'Reduce Operating Costs by 15%', progress: 73, status: 'Trending well' }
                ]
            }),
            'bottleneck-map': () => ({
                processes: [
                    { name: 'Design', time: 2, status: 'Good', severity: 'low' },
                    { name: 'Approval', time: 5, status: 'Bottleneck', severity: 'high' },
                    { name: 'Production', time: 6, status: 'Good', severity: 'low' },
                    { name: 'QC', time: 1, status: 'Good', severity: 'low' },
                    { name: 'Shipping', time: 3, status: 'Good', severity: 'low' }
                ]
            }),
            'task-manager': () => ({
                tasks: [],
                filter: 'all'
            })
        };

        const generator = dataGenerators[type];
        return generator ? generator() : {};
    }

    initializeChart(widget) {
        const ctx = document.getElementById(`chart-${widget.data.chartId}`);
        if (!ctx) return;

        let chartConfig = this.getChartConfig(widget);
        if (!chartConfig) return;

        // Destroy existing chart if it exists
        if (this.charts[widget.data.chartId]) {
            this.charts[widget.data.chartId].destroy();
        }

        this.charts[widget.data.chartId] = new Chart(ctx, chartConfig);
    }

    getChartConfig(widget) {
        const configs = {
            'cash-flow': () => ({
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Cash Flow',
                        data: [45000, -120000, 80000, -30000],
                        borderColor: '#7c8cfb',
                        backgroundColor: 'rgba(124, 140, 251, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: this.getChartOptions()
            }),
            'revenue-target': () => ({
                type: 'doughnut',
                data: {
                    labels: ['Achieved', 'Remaining'],
                    datasets: [{
                        data: [widget.data.actual, widget.data.target - widget.data.actual],
                        backgroundColor: ['#7c8cfb', 'rgba(255,255,255,0.1)']
                    }]
                },
                options: this.getChartOptions(true)
            }),
            'profit-product': () => ({
                type: 'bar',
                data: {
                    labels: widget.data.products,
                    datasets: [{
                        label: 'Margin %',
                        data: widget.data.margins,
                        backgroundColor: widget.data.margins.map(m => m < 0 ? '#e74c3c' : m < 20 ? '#f39c12' : '#27ae60')
                    }]
                },
                options: { ...this.getChartOptions(), indexAxis: 'y' }
            }),
            'accounts-receivable': () => ({
                type: 'doughnut',
                data: {
                    labels: ['Current', '30 days', '60 days', '90+ days'],
                    datasets: [{
                        data: [220000, 60000, 40000, 20000],
                        backgroundColor: ['#27ae60', '#f39c12', '#e67e22', '#e74c3c']
                    }]
                },
                options: this.getChartOptions(true)
            }),
            'delivery-trends': () => ({
                type: 'line',
                data: {
                    labels: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8', 'W9', 'W10', 'W11', 'W12'],
                    datasets: [{
                        label: 'Delivery Time',
                        data: [10, 10, 11, 10, 11, 11, 12, 11, 12, 12, 13, 12],
                        borderColor: '#7c8cfb',
                        tension: 0.4
                    }]
                },
                options: this.getChartOptions()
            }),
            'team-capacity': () => ({
                type: 'bar',
                data: {
                    labels: widget.data.teams,
                    datasets: [{
                        label: 'Utilization %',
                        data: widget.data.utilization,
                        backgroundColor: widget.data.utilization.map(u => u > 100 ? '#e74c3c' : u < 50 ? '#f39c12' : '#27ae60')
                    }]
                },
                options: { ...this.getChartOptions(), indexAxis: 'y' }
            }),
            'customer-health': () => ({
                type: 'pie',
                data: {
                    labels: widget.data.segments,
                    datasets: [{
                        data: widget.data.percentages,
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c']
                    }]
                },
                options: this.getChartOptions(true)
            }),
            'sales-pipeline': () => ({
                type: 'bar',
                data: {
                    labels: widget.data.stages,
                    datasets: [{
                        label: 'Pipeline Value',
                        data: widget.data.values,
                        backgroundColor: '#7c8cfb'
                    }]
                },
                options: this.getChartOptions()
            })
        };

        const configFn = configs[widget.type];
        return configFn ? configFn() : null;
    }

    getChartOptions(isDoughnut = false) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: isDoughnut,
                    labels: {
                        color: '#e6e8ee',
                        font: { size: 11 }
                    }
                }
            },
            scales: isDoughnut ? {} : {
                x: {
                    ticks: { color: '#a5adbf', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                },
                y: {
                    ticks: { color: '#a5adbf', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.05)' }
                }
            }
        };
    }
}
